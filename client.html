<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>실시간 자막 입력창 (서버 STT 연동)</title>
<style>
  :root{ --fg:#fff; --glass:rgba(0,0,0,.35); --shadow:rgba(0,0,0,.55);
         --accent1:#c9a6ff; --accent2:#7ad7ff; --radius:18px; }
  html,body{height:100%;margin:0}
  body{
    display:flex; align-items:flex-end; justify-content:center;
    background: radial-gradient(1200px 600px at 50% 20%, #0f1220 0%, #070910 55%, #05070c 100%);
    color:var(--fg);
    font-family: "Malgun Gothic","맑은 고딕","Apple SD Gothic Neo","Nanum Gothic",sans-serif;
    overflow:hidden;
  }
  :lang(en), .en{ font-family: Arial, Helvetica, sans-serif; }
  body::before{content:"";position:fixed;inset:0;box-shadow:inset 0 0 220px rgba(0,0,0,.65);pointer-events:none}
  .wrap{width:min(92vw,1100px); margin:0 auto 10vh; padding:0 12px}
  .panel{
    background:var(--glass); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
    border-radius:var(--radius); box-shadow:0 8px 28px var(--shadow);
    padding: clamp(10px,2.2vmin,20px) clamp(14px,3vmin,32px);
  }
  .current{
    font-weight:500;
    font-size: clamp(20px,3.6vmin,40px); line-height:1.45;
    letter-spacing:.2px; text-shadow:0 2px 10px rgba(0,0,0,.45);
    min-height:1.2em;
  }
  .current.typing .caret{
    display:inline-block; width:.6ch; height:1.05em; transform:translateY(3px);
    background:linear-gradient(180deg,var(--accent1),var(--accent2)); opacity:.8; margin-left:.1ch;
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}
  .rule{ margin:8px 0 10px; height:2px; opacity:.55; border-radius:999px;
         background:linear-gradient(90deg,var(--accent1),var(--accent2)); }
  .finals{ max-height:min(28vh, 250px); overflow:auto; scrollbar-width:thin; padding-right:4px; }
  .line{ font-size: clamp(16px,2.6vmin,26px);
         line-height:1.42; opacity:.95; margin:.2em 0; animation:fadeIn .35s ease both; }
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
  .meta{ display:flex; gap:10px; margin-top:8px; opacity:.9; font-size:.95rem; align-items:center; flex-wrap:wrap }
  .pill{ border:1px solid rgba(255,255,255,.25); border-radius:999px; padding:6px 12px; display:flex; align-items:center }
  .btn{ cursor:pointer; user-select:none }
  .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;background:#888;transition:background-color .2s ease}
  .on{background:#35d07f}.err{background:#ff6b6b}.processing{background:#ffaa00}
  .ctrl{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
  .btn2{
    border-radius:12px; border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08); color:#fff; padding:10px 14px; cursor:pointer; user-select:none;
  }
  .btn2:hover{background:rgba(255,255,255,.15)}
  .btn2:disabled{opacity:.5; cursor:not-allowed}
  .config{ font-size:.9rem; margin-bottom:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .config input{
    background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.25);
    color:#fff; padding:6px 10px; border-radius:8px; font-size:.9rem; flex:1; min-width:200px;
  }
  .config label{opacity:.8}
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel" role="region" aria-live="polite" aria-atomic="false">
      <!-- 서버 설정 -->
      <div class="config">
        <label>서버 주소:</label>
        <input type="text" id="serverUrl" value="http://localhost:8000/stt" placeholder="http://localhost:8000/stt">
      </div>
      
      <!-- 실시간(임시) 줄 -->
      <div id="current" class="current typing"><span id="currText"></span><span class="caret"></span></div>
      <div class="rule"></div>
      
      <!-- 확정 라인 목록 -->
      <div id="finals" class="finals" aria-label="확정 자막"></div>
      
      <!-- 메타 정보 -->
      <div class="meta">
        <div class="pill">
          <span id="recDot" class="status-dot"></span>
          <span id="recState">준비</span>
        </div>
        <div class="pill" id="langInfo" style="display:none">
          🌍 <span id="langText">-</span>
        </div>
      </div>
      
      <!-- 제어 -->
      <div class="ctrl">
        <button id="mic" class="btn2">🎤 녹음 시작</button>
        <button id="clear" class="btn2">🗑️ 초기화</button>
      </div>
    </div>
  </div>

<script>
/* ===== 설정 ===== */
const RECORD_DURATION = 5; // 녹음 시간 (초)

/* ===== DOM ===== */
const currEl   = document.getElementById('currText');
const current  = document.getElementById('current');
const finalsEl = document.getElementById('finals');
const micBtn   = document.getElementById('mic');
const clearBtn = document.getElementById('clear');
const recDot   = document.getElementById('recDot');
const recState = document.getElementById('recState');
const serverUrlInput = document.getElementById('serverUrl');
const langInfo = document.getElementById('langInfo');
const langText = document.getElementById('langText');

/* ===== 상태 ===== */
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];

/* ===== UI 함수 ===== */
function renderPartial(text){
  current.classList.add('typing');
  currEl.textContent = text || '';
}

function commitFinal(text, lang = null){
  const t = (text ?? '').trim();
  if(!t) return;
  
  const el = document.createElement('div');
  el.className = 'line';
  el.textContent = t;
  finalsEl.appendChild(el);
  finalsEl.scrollTop = finalsEl.scrollHeight;
  
  currEl.textContent = '';
  current.classList.remove('typing');
  
  if(lang){
    langText.textContent = lang;
    langInfo.style.display = 'flex';
  }
}

function setStatus(status, text){
  recDot.classList.remove('on','err','processing');
  if(status) recDot.classList.add(status);
  recState.textContent = text;
}

function clearAll(){
  finalsEl.innerHTML = '';
  currEl.textContent = '';
  current.classList.remove('typing');
  langInfo.style.display = 'none';
}

/* ===== STT 서버 통신 ===== */
async function sendToServer(audioBlob){
  const serverUrl = serverUrlInput.value.trim();
  if(!serverUrl){
    setStatus('err', '서버 주소 입력 필요');
    return;
  }
  
  setStatus('processing', '처리 중...');
  
  try {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.wav');
    
    const response = await fetch(serverUrl, {
      method: 'POST',
      body: formData
    });
    
    if(!response.ok){
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    
    if(result.success){
      // 원문 표시
      commitFinal(result.original, result.language);
      
      // 번역이 있으면 추가 표시
      if(result.translated && result.translated !== '(번역 실패)'){
        commitFinal(`→ ${result.translated}`);
      }
      
      setStatus('on', '완료');
      setTimeout(() => setStatus(null, '준비'), 2000);
    } else {
      throw new Error(result.error || '서버 처리 실패');
    }
    
  } catch(error){
    console.error('STT 에러:', error);
    setStatus('err', `오류: ${error.message}`);
    commitFinal(`[오류: ${error.message}]`);
  }
}

/* ===== 녹음 기능 ===== */
async function startRecording(){
  if(isRecording) return;
  
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    
    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
      
      // 스트림 정리
      stream.getTracks().forEach(track => track.stop());
      
      // 서버로 전송
      await sendToServer(audioBlob);
      
      isRecording = false;
      micBtn.textContent = '🎤 녹음 시작';
      micBtn.disabled = false;
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // 녹음 중 UI
    renderPartial('🎤 녹음 중...');
    setStatus('on', `녹음 중 (${RECORD_DURATION}초)`);
    micBtn.textContent = '⏸️ 녹음 중...';
    micBtn.disabled = true;
    
    // 카운트다운
    let remaining = RECORD_DURATION;
    const countdown = setInterval(() => {
      remaining--;
      if(remaining > 0){
        setStatus('on', `녹음 중 (${remaining}초)`);
      } else {
        clearInterval(countdown);
      }
    }, 1000);
    
    // 지정 시간 후 자동 중지
    setTimeout(() => {
      if(mediaRecorder && mediaRecorder.state === 'recording'){
        mediaRecorder.stop();
      }
      clearInterval(countdown);
    }, RECORD_DURATION * 1000);
    
  } catch(error){
    console.error('마이크 접근 에러:', error);
    setStatus('err', '마이크 접근 실패');
    alert('마이크 접근이 거부되었습니다.\n브라우저 설정에서 마이크 권한을 허용해주세요.');
  }
}

/* ===== 이벤트 리스너 ===== */
micBtn.addEventListener('click', startRecording);
clearBtn.addEventListener('click', clearAll);

/* ===== 키보드 단축키 ===== */
window.addEventListener('keydown', (e) => {
  if(e.code === 'Space' && !e.target.matches('input')){
    e.preventDefault();
    startRecording();
  }
});

/* ===== 초기화 ===== */
setStatus(null, '준비');

// URL 파라미터로 서버 주소 설정 가능
const params = new URLSearchParams(window.location.search);
if(params.has('server')){
  serverUrlInput.value = params.get('server');
}
</script>
</body>
</html>