<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‹¤ì‹œê°„ ìë§‰</title>
<style>
  :root{ --fg:#fff; --glass:rgba(0,0,0,.35); --shadow:rgba(0,0,0,.55);
         --accent1:#c9a6ff; --accent2:#7ad7ff; --radius:18px; }
  html,body{height:100%;margin:0}
  body{
    display:flex; 
    flex-direction: column;
    background: transparent;
    color:var(--fg);
    font-family: "Malgun Gothic","ë§‘ì€ ê³ ë”•","Apple SD Gothic Neo","Nanum Gothic",sans-serif;
    overflow:hidden;
    -webkit-app-region: drag;
  }
  :lang(en), .en{ font-family: Arial, Helvetica, sans-serif; }
  
  .controls{
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    align-items: center;
    z-index: 100;
    -webkit-app-region: no-drag;
  }
  
  .close-btn{
    background:rgba(255,50,50,.5);
    border-radius:6px; 
    border:none;
    color:#fff; 
    padding:6px 10px; 
    cursor:pointer;
    transition: background .2s;
    font-size: 0.9rem;
  }
  .close-btn:hover{ background:rgba(255,50,50,.7); }
  
  .opacity-control{
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(0,0,0,.5);
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,.2);
  }
  .opacity-control label{ font-size: 0.8rem; opacity: 0.9; }
  .opacity-control input[type="range"]{
    width: 80px; height: 4px; background: rgba(255,255,255,.3);
    border-radius: 2px; outline: none; -webkit-appearance: none;
  }
  .opacity-control input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance: none; width: 12px; height: 12px;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border-radius: 50%; cursor: pointer;
  }
  .opacity-control input[type="range"]::-moz-range-thumb{
    width: 12px; height: 12px;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border-radius: 50%; border: none; cursor: pointer;
  }
  .opacity-control span{ font-size: 0.8rem; min-width: 25px; text-align: right; opacity: 0.9; }
  
  .server-status{
    display: flex; align-items: center; gap: 6px; padding: 6px 10px;
    background: rgba(0,0,0,.5); border-radius: 6px; border: 1px solid rgba(255,255,255,.2);
  }
  .server-indicator{
    width: 12px; height: 12px; border-radius: 50%; background: #ff3232;
    transition: background 0.3s ease; box-shadow: 0 0 8px rgba(255, 50, 50, 0.5);
  }
  .server-indicator.connected{ background: #4caf50; box-shadow: 0 0 8px rgba(76, 175, 80, 0.5); }
  .server-status label{ font-size: 0.8rem; opacity: 0.9; }
  
  .content{ flex: 1; display:flex; align-items:flex-end; justify-content:center; overflow:hidden; }
  .wrap{ position: relative; width:min(92vw,1100px); margin:0 auto 10vh; padding:0 12px; }
  
  .panel{
    background:var(--glass);
    backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
    border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,.3);
    border: 1px solid rgba(255,255,255,.15);
    padding: clamp(10px,2.2vmin,20px) clamp(14px,3vmin,32px);
    transition: background 0.3s ease, border 0.3s ease;
  }
  .current{
    font-weight:500; font-size: clamp(20px,3.6vmin,40px); line-height:1.45;
    letter-spacing:.2px; text-shadow:0 2px 10px rgba(0,0,0,.8); min-height:1.2em;
  }
  .current.typing .caret{
    display:inline-block; width:.6ch; height:1.05em; transform:translateY(3px);
    background:linear-gradient(180deg,var(--accent1),var(--accent2)); opacity:.8; margin-left:.1ch;
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}
  .rule{ margin:8px 0 10px; height:2px; opacity:.55; border-radius:999px;
         background:linear-gradient(90deg,var(--accent1),var(--accent2)); }
  .status{ margin-top: 12px; padding: 8px 12px; background: transparent; border-radius: 8px; font-size: 0.9rem; opacity: 0.8; }
  .status.recording{ background: rgba(76,175,80,.3); }
</style>
</head>
<body>
  <div class="content">
    <div class="wrap">
      <div class="controls">
        <div class="server-status">
          <div class="server-indicator" id="serverIndicator"></div>
          <label>ì„œë²„</label>
        </div>
        <div class="opacity-control">
          <label>íˆ¬ëª…ë„</label>
          <input type="range" id="opacitySlider" min="0" max="100" value="0">
          <span id="opacityValue">0%</span>
        </div>
        <button id="closeBtn" type="button" class="close-btn">âœ•</button>
      </div>
      
      <div class="panel" id="mainPanel" role="region" aria-live="polite" aria-atomic="false">
        <div id="current" class="current typing">
          <span id="currText"></span>
          <span class="caret"></span>
        </div>
        <div class="rule"></div>
        <div id="status" class="status">Space í‚¤ë¥¼ ëˆŒëŸ¬ ë…¹ìŒì„ ì‹œì‘/ì¤‘ì§€í•˜ì„¸ìš”</div>
      </div>
    </div>
  </div>

<script>
/* ======= ì„¤ì • ======= */
// ì‹œê°„ì˜ì—­ RMS ì„ê³„ì¹˜(0~1). 0.015~0.03 ì‚¬ì´ì—ì„œ ì‹œì‘í•´ ë³´ì • ê¶Œì¥
const SILENCE_THRESHOLD_RMS = 0.02;
// ì¹¨ë¬µ ì§€ì† ì‹œê°„(ms). ë„ˆë¬´ ì˜ê²Œ ëŠê¸°ë©´ 200~400ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
const SILENCE_DURATION = 200;
// ìµœì†Œ ë…¹ìŒ ì‹œê°„(ms). ë¬¸ì¥ ë‹¨ìœ„ ì›í•˜ë©´ 1200~1800 ê¶Œì¥
const MIN_RECORD_DURATION = 900;
// ì„œë²„ URL
const SERVER_URL = 'https://edra-raspiest-eagerly.ngrok-free.dev/stt';

/* ======= DOM ======= */
const currEl = document.getElementById('currText');
const current = document.getElementById('current');
const statusEl = document.getElementById('status');
const closeBtn = document.getElementById('closeBtn');
const opacitySlider = document.getElementById('opacitySlider');
const opacityValue = document.getElementById('opacityValue');
const mainPanel = document.getElementById('mainPanel');
const serverIndicator = document.getElementById('serverIndicator');

/* ======= ìƒíƒœ ======= */
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let audioContext = null;
let analyser = null;
let silenceStart = null;
let checkInterval = null;
let stream = null;
let recordStartTime = null;
let recordingEnabled = false;
let isServerConnected = false;
let mimeType = 'audio/webm;codecs=opus';

/* ======= ìœ í‹¸/UI ======= */
function updateServerStatus(connected) {
  isServerConnected = connected;
  serverIndicator.classList.toggle('connected', connected);
}
function loadOpacity() {
  const saved = localStorage.getItem('panelOpacity');
  if (saved) opacitySlider.value = saved;
  updateOpacity(opacitySlider.value || 0);
}
function updateOpacity(value) {
  const transparency = value / 100;
  const bgOpacity = 1 * (1 - transparency);
  const borderOpacity = 0.15 * (1 - transparency);
  mainPanel.style.background = `rgba(0,0,0,${bgOpacity})`;
  mainPanel.style.borderColor = `rgba(255,255,255,${borderOpacity})`;
  opacityValue.textContent = value + '%';
  localStorage.setItem('panelOpacity', value);
}
function renderPartial(text){
  current.classList.add('typing');
  currEl.textContent = text || '';
}
function showResult(text){
  const t = (text ?? '').trim();
  if(!t) return;
  current.classList.add('typing');
  currEl.textContent = t;
}
function updateStatus(text, isRec = false) {
  statusEl.textContent = text;
  statusEl.classList.toggle('recording', isRec);
}

/* ======= ì„œë²„ í†µì‹  ======= */
async function sendToServer(audioBlob){
  try {
    const formData = new FormData();
    // ì„œë²„ê°€ webm/mp4 ë‘˜ ë‹¤ ë°›ì„ ìˆ˜ ìˆë‹¤ë©´ íŒŒì¼ í™•ì¥ìë§Œ ë§ì¶°ì£¼ë©´ ë¨
    const filename = mimeType.includes('mp4') ? 'recording.mp4' : 'recording.webm';
    formData.append('audio', audioBlob, filename);
    
    const response = await fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'ngrok-skip-browser-warning': 'true' },
      body: formData
    });
    
    if(!response.ok){
      const errorText = await response.text();
      console.error('ì„œë²„ ì‘ë‹µ:', errorText);
      updateServerStatus(false);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const result = await response.json();
    updateServerStatus(true);
    
    if(result.success){
      showResult(result.translated && result.translated !== '(ë²ˆì—­ ì‹¤íŒ¨)' ? result.translated : result.original);
    } else {
      throw new Error(result.error || 'ì„œë²„ ì²˜ë¦¬ ì‹¤íŒ¨');
    }
  } catch(error){
    console.error('STT ì—ëŸ¬:', error);
    updateServerStatus(false);
  }
}

/* ======= ì˜¤ë””ì˜¤/ì¹¨ë¬µ íŒì •(RMS) ======= */
function checkAudioLevel() {
  if (!analyser) return;
  const size = analyser.fftSize; // ì˜ˆ: 2048
  const buf = new Uint8Array(size);
  analyser.getByteTimeDomainData(buf);
  // 128ì´ ë¬´ì‹ í˜¸ ê¸°ì¤€. -1..1ë¡œ ì •ê·œí™” í›„ RMS ê³„ì‚°
  let sum = 0;
  for (let i = 0; i < size; i++) {
    const v = (buf[i] - 128) / 128; // -1..1
    sum += v * v;
  }
  const rms = Math.sqrt(sum / size); // 0..1

  if (rms < SILENCE_THRESHOLD_RMS) {
    if (!silenceStart) {
      silenceStart = Date.now();
    } else if (Date.now() - silenceStart >= SILENCE_DURATION) {
      if (recordStartTime && Date.now() - recordStartTime >= MIN_RECORD_DURATION) {
        stopRecording();
      }
    }
  } else {
    silenceStart = null; // ì†Œë¦¬ ê°ì§€ë˜ë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹
  }
}

/* ======= ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™” ======= */
async function initStream() {
  if (stream) return;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // MIME ìë™ì„ íƒ: webm ìš°ì„ , ë¶ˆê°€í•˜ë©´ mp4 (Safari)
    if (window.MediaRecorder) {
      if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
        mimeType = 'audio/webm;codecs=opus';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        mimeType = 'audio/mp4';
      } else {
        // ë¸Œë¼ìš°ì €ê°€ ì•„ë¬´ ê²ƒë„ ëª…ì‹œ ì§€ì› ì•ˆ í•˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œë„
        mimeType = '';
      }
    }

    // ë¶„ì„ìš© ì˜¤ë””ì˜¤ ë…¸ë“œ êµ¬ì„±
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
  } catch (error) {
    console.error('ë§ˆì´í¬ ì ‘ê·¼ ì—ëŸ¬:', error);
    alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    throw error;
  }
}

/* ======= ë…¹ìŒ ======= */
async function startRecording(){
  if(isRecording) return;
  try {
    await initStream();

    // MediaRecorder ìƒì„±
    mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
    audioChunks = [];
    recordStartTime = Date.now();

    mediaRecorder.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) audioChunks.push(event.data);
    };

    mediaRecorder.onstop = async () => {
      const duration = Date.now() - recordStartTime;
      if (duration >= MIN_RECORD_DURATION && audioChunks.length > 0) {
        const blobType = mimeType || 'audio/webm';
        const audioBlob = new Blob(audioChunks, { type: blobType });
        await sendToServer(audioBlob);
      }
      isRecording = false;
      audioChunks = [];
      silenceStart = null;
      recordStartTime = null;

      // ì—°ì† ë…¹ìŒ
      if (recordingEnabled) setTimeout(() => startRecording(), 100);
    };

    // 250ms íƒ€ì„ìŠ¬ë¼ì´ìŠ¤ë¡œ ë” ì´˜ì´˜íˆ ìˆ˜ì§‘(ì¹¨ë¬µ ì‹œ stopí•´ì„œ í•˜ë‚˜ì˜ ì„¸ê·¸ë¨¼íŠ¸ë¡œ ì—…ë¡œë“œ)
    mediaRecorder.start(250);
    isRecording = true;
    updateStatus('ğŸ¤ ë…¹ìŒ ì¤‘... (ì¹¨ë¬µ ê°ì§€ ì‹œ ìë™ ì „ì†¡)', true);

    // 10msë§ˆë‹¤ ë ˆë²¨ ì²´í¬
    if (!checkInterval) checkInterval = setInterval(checkAudioLevel, 10);

  } catch(error){
    console.error('ë…¹ìŒ ì‹œì‘ ì—ëŸ¬:', error);
  }
}
function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
}
function cleanupRecording() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  if (audioContext) { audioContext.close(); audioContext = null; }
  if (checkInterval) { clearInterval(checkInterval); checkInterval = null; }
  isRecording = false;
  silenceStart = null;
  updateStatus('Space í‚¤ë¥¼ ëˆŒëŸ¬ ë…¹ìŒì„ ì‹œì‘/ì¤‘ì§€í•˜ì„¸ìš”');
}

/* ======= ì´ë²¤íŠ¸ ======= */
closeBtn.addEventListener('click', () => { try { window.close(); } catch(_) {} });
opacitySlider.addEventListener('input', (e) => updateOpacity(e.target.value));

window.addEventListener('keydown', (e) => {
  if(e.code === 'Space' && !e.target.matches('input')){
    e.preventDefault();
    if (!recordingEnabled) {
      recordingEnabled = true;
      startRecording();
    } else {
      recordingEnabled = false;
      if (isRecording) stopRecording();
      cleanupRecording();
    }
  }
});

/* ======= ì´ˆê¸°í™” ======= */
loadOpacity();
// (ì„ íƒ) ìµœì´ˆì— ì„œë²„ í—¬ìŠ¤ì²´í¬í•˜ê³  ìƒíƒœë“± í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
// ;(async () => {
//   try {
//     const r = await fetch(SERVER_URL, { method: 'OPTIONS', headers: { 'ngrok-skip-browser-warning': 'true' } });
//     updateServerStatus(r.ok);
//   } catch { updateServerStatus(false); }
// })();
</script>
</body>
</html>
