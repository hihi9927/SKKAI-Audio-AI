<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì‹¤ì‹œê°„ ìë§‰</title>
<style>
  :root{ --fg:#fff; --glass:rgba(0,0,0,.35); --shadow:rgba(0,0,0,.55);
         --accent1:#c9a6ff; --accent2:#7ad7ff; --radius:18px; }
  html,body{height:100%;margin:0}
  body{
      display:flex; 
      flex-direction: column;
      background: transparent;
      color:var(--fg);
      font-family: "Malgun Gothic","ë§‘ì€ ê³ ë”•","Apple SD Gothic Neo","Nanum Gothic",sans-serif;
      overflow:hidden;
    }
  :lang(en), .en{ font-family: Arial, Helvetica, sans-serif; }
  
  .content{ 
      flex: 1; 
      display:flex; 
      align-items:flex-end; 
      justify-content:center; 
      overflow:hidden;
    }
  .wrap{ 
      position: relative; 
      width: min(92vw, 1100px);
      margin:0 auto 40px; 
      padding:0 12px;
    }
  
  .panel{
    background: rgba(20,20,20,.95);
    backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
    border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,.3);
    border: 1px solid rgba(255,255,255,.2);
    padding: clamp(10px,2.2vmin,20px) clamp(14px,3vmin,32px);
    transition: background 0.3s ease, border 0.3s ease;
    pointer-events: auto;
    user-select: none;
    position: relative;

    /* ì°½ ì „ì²´ ë“œë˜ê·¸ ê°€ëŠ¥(Electron) */
    -webkit-app-region: drag;
    cursor: move;
  }
  .panel:hover{
    background:rgba(20,20,20,1);
    border-color: rgba(255,255,255,.3);
  }
  .settings-btn{
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    background: rgba(255,255,255,.1);
    border: 1px solid rgba(255,255,255,.2);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;

    /* ì¸í„°ë™ì…˜ ê°€ëŠ¥ & ë“œë˜ê·¸ ì œì™¸ */
    pointer-events: auto;
    -webkit-app-region: no-drag;
    cursor: pointer;
  }
  .settings-btn:hover{
    background: rgba(255,255,255,.2);
    border-color: rgba(255,255,255,.35);
    transform: rotate(90deg);
  }
  .settings-btn svg{
    width: 18px;
    height: 18px;
    fill: #fff;
    opacity: 0.8;
  }
  .current{
    font-weight:500; font-size: clamp(20px,3.6vmin,40px); line-height:1.45;
    letter-spacing:.2px; text-shadow:0 2px 10px rgba(0,0,0,.8); min-height:1.2em;
    /* ìë§‰ í…ìŠ¤íŠ¸ ì˜ì—­ë§Œ ë“œë˜ê·¸ ì˜ì—­ìœ¼ë¡œ í•˜ë ¤ë©´ ì•„ë˜ ë‘ ì¤„ì„ í•´ì œí•˜ê³  .panelì˜ dragë¥¼ ë„ì„¸ìš”
    -webkit-app-region: drag;
    cursor: move;
    */
  }
  .current.initial{
    font-size: clamp(18px,3vmin,24px);
    text-align: center;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .current.typing .caret{
    display:inline-block; width:.6ch; height:1.05em; transform:translateY(3px);
    background:linear-gradient(180deg,var(--accent1),var(--accent2)); opacity:.8; margin-left:.1ch;
    animation:blink 1s step-end infinite;
  }
  @keyframes blink{50%{opacity:0}}
  
  /* ì„¤ì • íŒ¨ë„ ëª¨ë‹¬ */
  .settings-overlay{
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: transparent;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    -webkit-app-region: no-drag;
    pointer-events: none; /* ê¸°ë³¸ì€ í´ë¦­ ë§‰ìŒ */
  }
  .settings-overlay.show{
    display: flex;
    pointer-events: auto; /* ì—´ë ¸ì„ ë•Œë§Œ í´ë¦­ í—ˆìš© */
  }
  
  .settings-panel{
    background: rgba(20,20,20,.95);
    border-radius: 16px;
    padding: 24px 28px;
    width: 420px;
    max-height: 85vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,.2);
    box-shadow: 0 8px 32px rgba(0,0,0,.5);
    animation: slideUp 0.3s ease;

    /* í´ë¦­ ê°€ëŠ¥ & ë“œë˜ê·¸ ì œì™¸ */
    pointer-events: auto;
    -webkit-app-region: no-drag;
    cursor: default;
  }
  .settings-panel::-webkit-scrollbar{ width: 8px; }
  .settings-panel::-webkit-scrollbar-track{ background: rgba(255,255,255,.05); border-radius: 4px; }
  .settings-panel::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.2); border-radius: 4px; }
  .settings-panel::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.3); }
  @keyframes slideUp{
    from{ transform: translateY(20px); opacity: 0; }
    to{ transform: translateY(0); opacity: 1; }
  }
  
  .settings-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,.15);
  }
  .settings-header h2{
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header-controls{
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .status-indicators{
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .indicator-dot{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    transition: all 0.3s ease;
    position: relative;
    cursor: help;
  }
  .indicator-dot::after{
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 8px);
    right: 50%;
    transform: translateX(50%);
    background: rgba(0,0,0,.9);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    z-index: 1000;
  }
  .indicator-dot:hover::after{ opacity: 1; }
  .server-indicator-mini{
    background: #ff3232;
    box-shadow: 0 0 8px rgba(255, 50, 50, 0.6);
  }
  .server-indicator-mini.connected{
    background: #4caf50;
    box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
  }
  .recording-indicator-mini{
    background: #666;
    box-shadow: 0 0 8px rgba(102, 102, 102, 0.4);
  }
  .recording-indicator-mini.active{
    background: #ff9800;
    box-shadow: 0 0 8px rgba(255, 152, 0, 0.6);
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse{ 0%,100%{opacity:1;} 50%{opacity:.5;} }
  .close-settings{
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    padding: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;

    -webkit-app-region: no-drag;
    pointer-events: auto;
  }
  .close-settings:hover{ opacity: 1; }
  
  .settings-section{ margin-bottom: 18px; }
  .settings-section:last-child{ margin-bottom: 0; }
  .settings-label{
    display: block;
    font-size: 0.9rem;
    margin-bottom: 8px;
    opacity: 0.9;
    font-weight: 500;
  }
  
  .server-url-row{
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .server-url-input{
    flex: 1;
    min-width: 0;
    padding: 10px 12px;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 8px;
    font-size: 0.8rem;
    font-family: 'Courier New', monospace;
    color: #fff;
    outline: none;
    transition: all 0.2s;

    -webkit-app-region: no-drag;
    pointer-events: auto;
  }
  .server-url-input:focus{
    background: rgba(255,255,255,.08);
    border-color: var(--accent2);
  }
  .server-url-input::placeholder{ color: rgba(255,255,255,.4); }
  
  .opacity-row{
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .opacity-row input[type="range"]{
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,.2);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;

    -webkit-app-region: no-drag;
    pointer-events: auto;
    cursor: pointer;
  }
  .opacity-row input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
  }
  .opacity-row input[type="range"]::-moz-range-thumb{
    width: 16px;
    height: 16px;
    background: linear-gradient(135deg, var(--accent1), var(--accent2));
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,.3);
  }
  .opacity-value{
    min-width: 45px;
    text-align: right;
    font-size: 0.95rem;
    font-weight: 500;

    -webkit-app-region: no-drag;
    pointer-events: auto;
  }
  
  .translation-log{
    max-height: 300px;
    overflow-y: auto;
    padding: 12px 14px;
    background: rgba(255,255,255,.05);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,.1);

    -webkit-app-region: no-drag;
    pointer-events: auto;
  }
  .translation-log::-webkit-scrollbar{ width: 6px; }
  .translation-log::-webkit-scrollbar-track{ background: rgba(255,255,255,.05); border-radius: 3px; }
  .translation-log::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.2); border-radius: 3px; }
  .translation-log::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.3); }
  .log-entry{ margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,.08); }
  .log-entry:last-child{ margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
  .log-time{ font-size: 0.75rem; opacity: 0.6; margin-bottom: 4px; }
  .log-text{ font-size: 0.9rem; line-height: 1.4; }
  .log-empty{ text-align: center; opacity: 0.5; font-size: 0.85rem; padding: 20px 0; }
  
  .close-app-btn{
    width: 100%;
    padding: 12px;
    background: rgba(255,50,50,.6);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;

    -webkit-app-region: no-drag;
    pointer-events: auto;
  }
  .close-app-btn:hover{ background: rgba(255,50,50,.8); }
</style>
</head>
<body>
  <div class="content">
    <div class="wrap">
      <div class="panel" id="mainPanel" role="region" aria-live="polite" aria-atomic="false">
        <button class="settings-btn" id="settingsBtn" title="ì„¤ì •" aria-label="ì„¤ì • ì—´ê¸°">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
          </svg>
        </button>
        <div id="current" class="current initial">
          <span id="currText">Space í‚¤ë¥¼ ëˆŒëŸ¬ ë…¹ìŒì„ ì‹œì‘í•˜ì„¸ìš”</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • íŒ¨ë„ ëª¨ë‹¬ -->
  <div class="settings-overlay" id="settingsOverlay" aria-hidden="true">
    <div class="settings-panel" onclick="event.stopPropagation()">
      <div class="settings-header">
        <h2>ì„¤ì •</h2>
        <div class="header-controls">
          <div class="status-indicators">
            <div class="indicator-dot server-indicator-mini" id="serverIndicatorMini" data-tooltip="ì„œë²„ ì—°ê²° ìƒíƒœ"></div>
            <div class="indicator-dot recording-indicator-mini" id="recordingIndicatorMini" data-tooltip="ë…¹ìŒ ìƒíƒœ"></div>
          </div>
          <button class="close-settings" id="closeSettings" aria-label="ì„¤ì • ë‹«ê¸°">âœ•</button>
        </div>
      </div>
      
      <div class="settings-section">
        <label class="settings-label" for="serverUrlInput">ì„œë²„ URL</label>
        <div class="server-url-row">
          <input type="text" class="server-url-input" id="serverUrlInput" 
                 value="https://edra-raspiest-eagerly.ngrok-free.dev/stt"
                 placeholder="ì„œë²„ URLì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
      </div>
      
      <div class="settings-section">
        <label class="settings-label" for="opacitySlider">ë°°ê²½ íˆ¬ëª…ë„</label>
        <div class="opacity-row">
          <input type="range" id="opacitySlider" min="0" max="100" value="0">
          <span class="opacity-value" id="opacityValue">0%</span>
        </div>
      </div>
      
      <div class="settings-section">
        <label class="settings-label">ë²ˆì—­ ë¡œê·¸</label>
        <div class="translation-log" id="translationLog">
          <div class="log-empty">ì•„ì§ ë²ˆì—­ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
      
      <div class="settings-section">
        <button class="close-app-btn" id="closeAppBtn">ì•± ì¢…ë£Œ</button>
      </div>
    </div>
  </div>

<script>
/* ======= ì„¤ì • ======= */
const SILENCE_THRESHOLD_RMS = 0.02;
const SILENCE_DURATION = 200;
const MIN_RECORD_DURATION = 900;
let SERVER_URL = 'https://edra-raspiest-eagerly.ngrok-free.dev/stt';

/* ======= DOM ======= */
const currEl = document.getElementById('currText');
const current = document.getElementById('current');
const mainPanel = document.getElementById('mainPanel');
const settingsBtn = document.getElementById('settingsBtn');
const settingsOverlay = document.getElementById('settingsOverlay');
const closeSettings = document.getElementById('closeSettings');
const serverIndicatorMini = document.getElementById('serverIndicatorMini');
const recordingIndicatorMini = document.getElementById('recordingIndicatorMini');
const serverUrlInput = document.getElementById('serverUrlInput');
const opacitySlider = document.getElementById('opacitySlider');
const opacityValue = document.getElementById('opacityValue');
const translationLog = document.getElementById('translationLog');
const closeAppBtn = document.getElementById('closeAppBtn');

/* ======= ìƒíƒœ ======= */
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let audioContext = null;
let analyser = null;
let silenceStart = null;
let checkInterval = null;
let stream = null;
let recordStartTime = null;
let recordingEnabled = false;
let isServerConnected = false;
let mimeType = 'audio/webm;codecs=opus';
let translationHistory = [];

/* ======= ìœ í‹¸/UI ======= */
function updateServerStatus(connected) {
  isServerConnected = connected;
  serverIndicatorMini.classList.toggle('connected', connected);
}

function updateRecordingStatus(recording) {
  recordingIndicatorMini.classList.toggle('active', recording);
}

function loadOpacity() {
  const saved = localStorage.getItem('panelOpacity');
  if (saved) opacitySlider.value = saved;
  updateOpacity(opacitySlider.value || 0);
}

function updateOpacity(value) {
  const transparency = value / 100;
  const bgOpacity = 0.95 * (1 - transparency);
  const borderOpacity = 0.2 * (1 - transparency);
  mainPanel.style.background = `rgba(20,20,20,${bgOpacity})`;
  mainPanel.style.borderColor = `rgba(255,255,255,${borderOpacity})`;
  opacityValue.textContent = value + '%';
  localStorage.setItem('panelOpacity', value);
}

function showResult(text){
  const t = (text ?? '').trim();
  if(!t) return;
  current.classList.remove('initial');
  current.classList.add('typing');
  currEl.textContent = t;
  
  // ë¡œê·¸ì— ì¶”ê°€
  addToLog(t);
}

function addToLog(text) {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  
  translationHistory.unshift({ time: timeStr, text });
  if (translationHistory.length > 50) translationHistory.pop(); // ìµœëŒ€ 50ê°œ ìœ ì§€
  
  updateLogDisplay();
}

function updateLogDisplay() {
  if (translationHistory.length === 0) {
    translationLog.innerHTML = '<div class="log-empty">ì•„ì§ ë²ˆì—­ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  
  translationLog.innerHTML = translationHistory.map(entry => `
    <div class="log-entry">
      <div class="log-time">${entry.time}</div>
      <div class="log-text">${entry.text}</div>
    </div>
  `).join('');
}

/* ======= ì„¤ì • íŒ¨ë„ í† ê¸€ ======= */
function toggleSettings() {
  const wasOpen = settingsOverlay.classList.contains('show');
  settingsOverlay.classList.toggle('show');
  settingsOverlay.setAttribute('aria-hidden', wasOpen ? 'true' : 'false');
  
  // ì„¤ì •ì°½ì´ ì—´ë¦´ ë•Œ ì°½ í¬ê¸° ì¡°ì •
  if (!wasOpen && window.require) {
    setTimeout(() => {
      updateWindowHeight();
    }, 100);
  }
}

// ì„¤ì • ë²„íŠ¼ í´ë¦­
settingsBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  toggleSettings();
});

closeSettings.addEventListener('click', toggleSettings);

// ì˜¤ë²„ë ˆì´ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
settingsOverlay.addEventListener('click', (e) => {
  if (e.target === settingsOverlay) toggleSettings();
});

// ESC í‚¤ë¡œ ì„¤ì •ì°½ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && settingsOverlay.classList.contains('show')) {
    toggleSettings();
  }
});

/* ======= ì„œë²„ í†µì‹  ======= */
async function sendToServer(audioBlob){
  try {
    const formData = new FormData();
    const filename = mimeType.includes('mp4') ? 'recording.mp4' : 'recording.webm';
    formData.append('audio', audioBlob, filename);
    
    const response = await fetch(SERVER_URL, {
      method: 'POST',
      headers: { 'ngrok-skip-browser-warning': 'true' },
      body: formData
    });
    
    if(!response.ok){
      const errorText = await response.text();
      console.error('ì„œë²„ ì‘ë‹µ:', errorText);
      updateServerStatus(false);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const result = await response.json();
    updateServerStatus(true);
    
    if(result.success){
      showResult(result.translated && result.translated !== '(ë²ˆì—­ ì‹¤íŒ¨)' ? result.translated : result.original);
    } else {
      throw new Error(result.error || 'ì„œë²„ ì²˜ë¦¬ ì‹¤íŒ¨');
    }
  } catch(error){
    console.error('STT ì—ëŸ¬:', error);
    updateServerStatus(false);
  }
}

/* ======= ì˜¤ë””ì˜¤/ì¹¨ë¬µ íŒì •(RMS) ======= */
function checkAudioLevel() {
  if (!analyser) return;
  const size = analyser.fftSize;
  const buf = new Uint8Array(size);
  analyser.getByteTimeDomainData(buf);
  let sum = 0;
  for (let i = 0; i < size; i++) {
    const v = (buf[i] - 128) / 128;
    sum += v * v;
  }
  const rms = Math.sqrt(sum / size);

  if (rms < SILENCE_THRESHOLD_RMS) {
    if (!silenceStart) {
      silenceStart = Date.now();
    } else if (Date.now() - silenceStart >= SILENCE_DURATION) {
      if (recordStartTime && Date.now() - recordStartTime >= MIN_RECORD_DURATION) {
        stopRecording();
      }
    }
  } else {
    silenceStart = null;
  }
}

/* ======= ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™” ======= */
async function initStream() {
  if (stream) return;
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    if (window.MediaRecorder) {
      if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
        mimeType = 'audio/webm;codecs=opus';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        mimeType = 'audio/mp4';
      } else {
        mimeType = '';
      }
    }

    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
  } catch (error) {
    console.error('ë§ˆì´í¬ ì ‘ê·¼ ì—ëŸ¬:', error);
    alert('ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
    throw error;
  }
}

/* ======= ë…¹ìŒ ======= */
async function startRecording(){
  if(isRecording) return;
  try {
    await initStream();

    mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
    audioChunks = [];
    recordStartTime = Date.now();

    mediaRecorder.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) audioChunks.push(event.data);
    };

    mediaRecorder.onstop = async () => {
      const duration = Date.now() - recordStartTime;
      if (duration >= MIN_RECORD_DURATION && audioChunks.length > 0) {
        const blobType = mimeType || 'audio/webm';
        const audioBlob = new Blob(audioChunks, { type: blobType });
        await sendToServer(audioBlob);
      }
      isRecording = false;
      audioChunks = [];
      silenceStart = null;
      recordStartTime = null;
      updateRecordingStatus(false);

      if (recordingEnabled) setTimeout(() => startRecording(), 100);
    };

    mediaRecorder.start(250);
    isRecording = true;
    updateRecordingStatus(true);

    if (!checkInterval) checkInterval = setInterval(checkAudioLevel, 10);

  } catch(error){
    console.error('ë…¹ìŒ ì‹œì‘ ì—ëŸ¬:', error);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
}

function cleanupRecording() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  if (audioContext) { audioContext.close(); audioContext = null; }
  if (checkInterval) { clearInterval(checkInterval); checkInterval = null; }
  isRecording = false;
  silenceStart = null;
  updateRecordingStatus(false);
}

/* ======= ì´ë²¤íŠ¸ ======= */
closeAppBtn.addEventListener('click', () => { 
  try { window.close(); } catch(_) {} 
});

opacitySlider.addEventListener('input', (e) => updateOpacity(e.target.value));

// ì„œë²„ URL ë³€ê²½ ì‹œ ì €ì¥
serverUrlInput.addEventListener('change', (e) => {
  SERVER_URL = e.target.value.trim();
  localStorage.setItem('serverUrl', SERVER_URL);
});

// ì„œë²„ URL ë¡œë“œ
function loadServerUrl() {
  const saved = localStorage.getItem('serverUrl');
  if (saved) {
    SERVER_URL = saved;
    serverUrlInput.value = saved;
  }
}

window.addEventListener('keydown', (e) => {
  if(e.code === 'Space' && !e.target.matches('input')){
    e.preventDefault();
    if (!recordingEnabled) {
      recordingEnabled = true;
      startRecording();
    }
  }
});

window.addEventListener('keyup', (e) => {
  if(e.code === 'Space' && !e.target.matches('input')){
    e.preventDefault();
    recordingEnabled = false;
    stopRecording();
    cleanupRecording();
  }
});

/* ======= Electron ì°½ í¬ê¸° ì¡°ì • (ìˆ˜ì •) ======= */
function updateWindowHeight() {
  if (!window.require) return;
  try {
    const { ipcRenderer } = window.require('electron');
    // í•­ìƒ ë©”ì¸ íŒ¨ë„ ê¸°ì¤€ìœ¼ë¡œë§Œ ë¦¬ì‚¬ì´ì¦ˆ â†’ ì„¤ì •ì°½ì´ ì—´ë ¤ë„ ì°½ í¬ê¸° ê³ ì • ëŠë‚Œ
    const mainPanelHeight = mainPanel.offsetHeight;
    ipcRenderer.send('resize-window', mainPanelHeight + 100);
  } catch(e) {
    console.log('Electron í™˜ê²½ì´ ì•„ë‹™ë‹ˆë‹¤');
  }
}

// ResizeObserverë¡œ ì°½ í¬ê¸° ìë™ ì¡°ì •
if (window.ResizeObserver) {
  const resizeObserver = new ResizeObserver(() => {
    updateWindowHeight();
  });
  resizeObserver.observe(mainPanel);
}

/* ======= íˆ¬ëª…ì°½ í´ë¦­ í†µê³¼ ì œì–´ (ìˆ˜ì •) ======= */
const { ipcRenderer } = window.require ? window.require('electron') : {};

if (ipcRenderer) {
  let isOverInteractive = false;

  document.addEventListener('mousemove', (e) => {
    const target = e.target;
    const isOverPanel = mainPanel.contains(target) ||
      (settingsOverlay.classList.contains('show') && document.querySelector('.settings-panel')?.contains(target));

    if (isOverPanel !== isOverInteractive) {
      isOverInteractive = isOverPanel;
      // ì¸í„°ë™í‹°ë¸Œ ìœ„ë©´ í´ë¦­ í—ˆìš©(false), ì•„ë‹ˆë©´ í†µê³¼(true)
      ipcRenderer.send('set-ignore-mouse-events', !isOverInteractive, { forward: true });
    }
  });

  // ğŸ”§ toggleSettingsë¥¼ ë˜í•‘í•´ì„œ ì—´ê³ /ë‹«ì„ ë•Œ ìƒíƒœë¥¼ â€œëª…ì‹œì ìœ¼ë¡œâ€ ì„¸íŒ…
  const originalToggle = toggleSettings;
  toggleSettings = function () {
    originalToggle();

    // ì—´ë¦¼/ë‹«í˜ ì§í›„ ìƒíƒœë¥¼ í™•ì‹¤í•˜ê²Œ ë°˜ì˜
    const opened = settingsOverlay.classList.contains('show');
    ipcRenderer.send('set-ignore-mouse-events', !opened, { forward: true });

    // ì°½ ë†’ì´ëŠ” í•­ìƒ ë©”ì¸ íŒ¨ë„ ê¸°ì¤€ìœ¼ë¡œë§Œ
    setTimeout(updateWindowHeight, 50);
  };
}

/* ======= ì´ˆê¸°í™” ======= */
loadOpacity();
loadServerUrl();
updateServerStatus(false);
updateRecordingStatus(false);

// ì´ˆê¸° ì°½ í¬ê¸° ì„¤ì •
setTimeout(updateWindowHeight, 100);
</script>
</body>
</html>
